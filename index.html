<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlaskCon Africa - Sponsorship Outreach Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Corrected import statement
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: The following configuration will be publicly visible in your deployed site.
        // Security is enforced by your Firestore Security Rules, not by hiding these keys.
        const firebaseConfig = {
            apiKey: "RANDOM",
            authDomain: "RANDOM",
            projectId: "RANDOM",
            storageBucket: "RANDOM",
            messagingSenderId: "RANDOM",
            appId: "RANDOM",
            measurementId: "RANDOM"
        };
        
        // Make Firebase functions available globally
        window.firebase = {
            initializeApp,
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserSessionPersistence,
            signInWithCustomToken, // Now only includes signInWithCustomToken
            getFirestore,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDoc,
            firebaseConfig
        };
    </script>
    <style>
        :root {
            --primary: #534EFF;
            --secondary: #C200FB;
            --tertiary: #EC0868;
            --accent1: #FC2F00;
            --accent2: #EC7D10;
            --accent3: #FFBC0A;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f4;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="error-modal" class="fixed z-20 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <div class="bg-white rounded-lg px-4 pt-5 pb-4 overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.52-1.614 1.748-3.098l-6.928-11.666c-.78-1.314-2.584-1.314-3.364 0L4.316 17.902c-.772 1.484.208 3.098 1.748 3.098z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="error-title">Error</h3>
                        <div class="mt-2">
                            <p id="error-message" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-error-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 text-center">
            <div class="flex flex-col items-center justify-center">
                <img src="https://placehold.co/100x100/534EFF/FFFFFF?text=Logo" alt="FlaskCon Africa Logo" class="h-20 w-20 mb-4 rounded-full">
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900">Sign in to the Sponsorship Dashboard</h2>
            </div>
            <p class="mt-2 text-sm text-gray-600">Please sign in with your Google account to continue.</p>
            <div id="auth-loading" class="flex justify-center hidden">
                <div class="loader"></div>
            </div>
            <button id="google-signin-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-indigo-500 group-hover:text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px">
                        <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20c11.452 0 20.803-8.835 21.722-20.083z"/>
                        <path fill="#FF3D00" d="M6.306 14.691L1.649 9.076C3.268 6.012 5.753 3.424 8.791 1.942l5.086 4.093C11.96 7.466 9.94 8.718 8.444 10.395z"/>
                        <path fill="#4CAF50" d="M14.077 41.691c-1.897-.933-3.844-2.181-5.69-3.79L2.392 31.332C1.517 28.536 1 25.594 1 22.5c0-3.094.517-6.036 1.392-8.832l4.995-6.526 5.657 5.657c-1.921 2.393-3.13 5.373-3.13 8.651s1.209 6.258 3.13 8.651l-5.657 5.657z"/>
                        <path fill="#1976D2" d="M24 44c5.166 0 9.86-1.973 13.409-5.192l-6.19-5.238c-2.155 1.503-4.82 2.4-7.219 2.4-3.14 0-5.932-1.229-8.087-3.238l-5.657 5.657C14.042 41.879 18.736 44 24 44z"/>
                        <path fill="none" d="M0 0h48v48H0z"/>
                    </svg>
                </span>
                Sign in with Google
            </button>
        </div>
    </div>
    
    <div id="main-dashboard" class="flex flex-col md:flex-row min-h-screen hidden">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white p-6 shadow-md md:shadow-lg md:h-screen sticky top-0">
            <div class="flex items-center space-x-2 mb-8">
                <img src="https://placehold.co/40x40/534EFF/FFFFFF?text=Logo" alt="Logo" class="h-10 w-10 rounded-full">
                <h1 class="text-xl font-bold text-gray-900">Sponsorship</h1>
            </div>
            <nav class="space-y-2">
                <a href="#" class="flex items-center space-x-3 p-3 rounded-lg text-white font-medium bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] shadow-lg hover:opacity-90 transition-opacity duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
            </nav>
            <div class="mt-8">
                <button id="signout-btn" class="w-full flex items-center space-x-3 p-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span>Sign Out</span>
                </button>
            </div>
            <div id="user-info" class="mt-auto pt-6 border-t border-gray-200">
                <p class="text-sm text-gray-500">Logged in as:</p>
                <p id="user-display-name" class="font-medium text-gray-900"></p>
                <p id="user-id" class="text-xs text-gray-400 truncate"></p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10">
            <div class="flex justify-between items-center mb-6 md:mb-10">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Sponsorship Dashboard</h2>
                <button id="add-sponsor-btn" class="bg-gradient-to-r from-[var(--tertiary)] to-[var(--accent1)] text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:opacity-90 transition-opacity duration-200 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span>Add Sponsor</span>
                </button>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Total Sponsors Widget -->
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-3 bg-[var(--primary)] rounded-full text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-3m-6-1c0-4.418-3.582-8-8-8s-8 3.582-8 8H7a1 1 0 011 1v4a1 1 0 01-1 1H4.5M10 9a2 2 0 100-4 2 2 0 000 4z" />
                                </svg>
                            </div>
                            <p class="text-lg font-medium text-gray-500">Total Sponsors</p>
                        </div>
                        <div id="total-sponsors-count" class="text-4xl font-bold text-gray-900">0</div>
                    </div>

                    <!-- Total Pledged Widget -->
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-3 bg-[var(--accent2)] rounded-full text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 12v-2m-6-2v2h2m6-6h2m-2 0h-2m2 0h-2M4 6h2a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" />
                                </svg>
                            </div>
                            <p class="text-lg font-medium text-gray-500">Total Pledged</p>
                        </div>
                        <div id="total-pledged-amount" class="text-4xl font-bold text-gray-900">₦0</div>
                    </div>
                
                    <!-- Outreach Status Widget -->
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-3 bg-[var(--tertiary)] rounded-full text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
                                </svg>
                            </div>
                            <p class="text-lg font-medium text-gray-500">Outreach Status</p>
                        </div>
                        <div id="outreach-status-count" class="text-4xl font-bold text-gray-900">0</div>
                    </div>

                    <!-- Pledged vs Goal Widget -->
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="p-3 bg-[var(--accent3)] rounded-full text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3 3 7-7m2 4a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <p class="text-lg font-medium text-gray-500">Goal Progress</p>
                        </div>
                        <div id="goal-progress" class="text-4xl font-bold text-gray-900">0%</div>
                    </div>
                </div>

                <aside class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-bold mb-4">Outreach Strategy</h2>
                        <div class="space-y-4 text-sm text-gray-600">
                            <p><strong>1. Initial Contact:</strong> Use the email template and follow up with a LinkedIn connection request.</p>
                            <p><strong>2. Follow-Up:</strong> If no response in 5-7 days, send a polite follow-up email or LinkedIn message.</p>
                            <p><strong>3. Track Status:</strong> Update the status of each lead in your master tracker sheet as you make progress.</p>
                            <button id="showEmailBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">View Email Draft</button>
                        </div>
                    </div>
                </aside>
            </div>
            <!-- Dashboard Widgets -->

            <!-- Sponsor Table and Charts -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-900">Sponsor Details</h3>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex space-x-2">
                        <input type="text" id="search-input" placeholder="Search by company..." class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] text-sm">
                        <select id="status-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] text-sm">
                            <option value="all">All Statuses</option>
                            <option value="Researching">Researching</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Pledged">Pledged</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tier</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sponsors-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Sponsor data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="no-sponsors-message" class="text-center py-4 text-gray-500 hidden">
                    No sponsors found. Add a new one to get started!
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sponsor Status Chart -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900">Sponsor Status Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="sponsorStatusChart"></canvas>
                    </div>
                </div>
                <!-- Pledged Tiers Chart -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900">Pledged Tiers</h3>
                    <div class="chart-container">
                        <canvas id="pledgedTiersChart"></canvas>
                    </div>
                </div>

                <!-- <aside class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-bold mb-4">Outreach Strategy</h2>
                        <div class="space-y-4 text-sm text-gray-600">
                            <p><strong>1. Initial Contact:</strong> Use the email template and follow up with a LinkedIn connection request.</p>
                            <p><strong>2. Follow-Up:</strong> If no response in 5-7 days, send a polite follow-up email or LinkedIn message.</p>
                            <p><strong>3. Track Status:</strong> Update the status of each lead in your master tracker sheet as you make progress.</p>
                            <button id="showEmailBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition">View Email Draft</button>
                        </div>
                    </div>
                </aside> -->
            </div>

        </main>
    </div>

    <div id="emailModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Outreach Email Draft</h3>
                <div class="mt-4 bg-gray-50 p-4 rounded-md text-sm text-gray-700">
                  <p><strong>Subject:</strong> Partnership with [Company Name] for FlaskCon Africa 2025</p>
                  <br>
                  <p>Dear [Contact Name],</p>
                  <br>
                  <p>My name is [Your Name], and I'm a member of the organizing team for FlaskCon Africa, a premier community event for Flask and Python developers across the continent. Our mission is to build a stronger, more connected African tech community.</p>
                  <br>
                  <p>I'm reaching out because of [<strong>PERSONALIZATION POINT</strong> - e.g., your company's great work in the fintech space]. Given your focus on [<strong>THEIR INDUSTRY</strong>], we believe a partnership with FlaskCon Africa would be a perfect fit to help you connect with a highly relevant audience of developers and showcase your commitment to the African tech ecosystem.</p>
                  <br>
                  <p>I've attached our sponsorship deck for your review, which outlines various partnership tiers and custom options.</p>
                  <br>
                  <p>Would you be available for a brief 15-minute call sometime next week to discuss how we can create a partnership that meets your goals?</p>
                  <br>
                  <p>Thank you for your time and consideration.</p>
                  <br>
                  <p>Best regards,</p>
                  <p>[Your Name]</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="button" id="closeEmailBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Sponsor Modal -->
    <div id="add-edit-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                <form id="sponsor-form" class="p-6">
                    <h3 id="modal-title" class="text-lg font-medium text-gray-900 mb-4">Add Sponsor</h3>
                    <input type="hidden" id="sponsor-id">
                    <div class="space-y-4">
                        <div>
                            <label for="companyName" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" id="companyName" name="companyName" required class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                        </div>
                        <div>
                            <label for="contactPerson" class="block text-sm font-medium text-gray-700">Contact Person</label>
                            <input type="text" id="contactPerson" name="contactPerson" class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" name="email" class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                        </div>
                        <div>
                            <label for="tier" class="block text-sm font-medium text-gray-700">Sponsorship Tier</label>
                            <select id="tier" name="tier" class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                                <option value="">Select a tier</option>
                                <option value="Gold">Gold (₦1M)</option>
                                <option value="Silver">Silver (₦500k)</option>
                                <option value="Bronze">Bronze (₦200k)</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div>
                            <label for="pledgedAmount" class="block text-sm font-medium text-gray-700">Pledged Amount (₦)</label>
                            <input type="number" id="pledgedAmount" name="pledgedAmount" class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" required class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2">
                                <option value="Researching">Researching</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Follow-up">Follow-up</option>
                                <option value="Pledged">Pledged</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-400 shadow-md focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)] text-base p-2"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                            Cancel
                        </button>
                        <button type="submit" class="bg-[var(--primary)] text-white font-semibold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-opacity duration-200">
                            Save Sponsor
                        </button>
                    </div>
                </form>
                <div class="bg-gray-50 px-4 py-3 flex justify-end">
                    <button id="delete-btn" class="text-sm text-red-600 hover:text-red-800 transition-colors duration-200 hidden">
                        Delete Sponsor
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        let db, auth, sponsorStatusChart, pledgedTiersChart, userId, collection;
        const sponsorshipGoal = 5000000; // ₦5,000,000

        window.onload = async () => {
            try {
                // IMPORTANT: Use the provided global variables __firebase_config, __initial_auth_token, and __app_id
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : window.firebase.firebaseConfig;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(app);
                auth = window.firebase.getAuth(app);
                collection = window.firebase.collection;
                const showEmailBtn = document.getElementById('showEmailBtn');
                const closeEmailBtn = document.getElementById('closeEmailBtn');
                const emailModal = document.getElementById('emailModal');

                showEmailBtn.addEventListener('click', () => {
                    emailModal.classList.remove('hidden');
                });

                closeEmailBtn.addEventListener('click', () => {
                    emailModal.classList.add('hidden');
                });

                emailModal.addEventListener('click', (event) => {
                    if (event.target === emailModal) {
                        emailModal.classList.add('hidden');
                    }
                });
                
                await window.firebase.setPersistence(auth, window.firebase.browserSessionPersistence);

                const toggleUI = (isSignedIn) => {
                    document.getElementById('auth-container').classList.toggle('hidden', isSignedIn);
                    document.getElementById('main-dashboard').classList.toggle('hidden', !isSignedIn);
                };

                const displayError = (title, message) => {
                    const errorModal = document.getElementById('error-modal');
                    document.getElementById('error-title').textContent = title;
                    document.getElementById('error-message').textContent = message;
                    errorModal.classList.remove('hidden');
                };

                // Close error modal
                document.getElementById('close-error-btn').addEventListener('click', () => {
                    document.getElementById('error-modal').classList.add('hidden');
                });


                if (initialAuthToken) {
                    try {
                        document.getElementById('auth-loading').classList.remove('hidden');
                        const userCredential = await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token:", userCredential.user.uid);
                    } catch (error) {
                        console.error("Custom token sign-in failed:", error);
                        displayError("Authentication Error", "Failed to sign in with the provided token. Please try again.");
                    }
                }
                
                window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-display-name').textContent = user.displayName || 'Authenticated User';
                        document.getElementById('user-id').textContent = `User ID: ${userId}`;
                        toggleUI(true);
                        initDashboard();
                    } else {
                        // User is signed out or not authenticated
                        userId = null;
                        toggleUI(false);
                    }
                    // Hide the loading spinner once auth state is checked
                    document.getElementById('auth-loading').classList.add('hidden');
                });


                // Handle Google Sign-in
                document.getElementById('google-signin-btn').addEventListener('click', async () => {
                    const provider = new window.firebase.GoogleAuthProvider();
                    try {
                        document.getElementById('auth-loading').classList.remove('hidden');
                        await window.firebase.signInWithPopup(auth, provider);
                        // The onAuthStateChanged listener above will handle the UI update
                    } catch (error) {
                        console.error("Google Sign-in Error: ", error);
                        displayError("Authentication Error", "Failed to sign in with Google. Please try again.");
                        document.getElementById('auth-loading').classList.add('hidden');
                    }
                });


                // Handle Sign-out
                document.getElementById('signout-btn').addEventListener('click', async () => {
                    try {
                        await window.firebase.signOut(auth);
                        console.log("User signed out.");
                    } catch (error) {
                        console.error("Sign-out Error: ", error);
                        displayError("Sign-out Error", "Failed to sign out. Please try again.");
                    }
                });

                // Helper function to format currency
                const formatCurrency = (amount) => {
                    return `₦${new Intl.NumberFormat('en-NG', {
                        style: 'decimal',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(amount)}`;
                };

                // Helper function to render a single sponsor row
                const renderSponsorRow = (sponsor, docId) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors duration-200 cursor-pointer';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sponsor.companyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sponsor.contactPerson || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sponsor.tier || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(sponsor.status)}">
                                ${sponsor.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${sponsor.notes || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex space-x-0">
                                <button class="text-[var(--primary)] hover:text-[var(--secondary)] edit-btn" data-id="${docId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    return row;
                };

                const getStatusBadgeClass = (status) => {
                    switch (status) {
                        case 'Researching':
                            return 'bg-gray-100 text-gray-800';
                        case 'Contacted':
                            return 'bg-blue-100 text-blue-800';
                        case 'Follow-up':
                            return 'bg-yellow-100 text-yellow-800';
                        case 'Pledged':
                            return 'bg-green-100 text-green-800';
                        case 'Closed':
                            return 'bg-purple-100 text-purple-800';
                        default:
                            return 'bg-gray-100 text-gray-800';
                    }
                };

                const updateCharts = (sponsors) => {
                    const statusCounts = sponsors.reduce((acc, sponsor) => {
                        acc[sponsor.status] = (acc[sponsor.status] || 0) + 1;
                        return acc;
                    }, {});

                    const pledgedTiers = sponsors.filter(s => s.status === 'Pledged').reduce((acc, sponsor) => {
                        acc[sponsor.tier] = (acc[sponsor.tier] || 0) + (sponsor.pledgedAmount || 0);
                        return acc;
                    }, {});

                    // Sponsor Status Chart
                    if (sponsorStatusChart) sponsorStatusChart.destroy();
                    const statusLabels = Object.keys(statusCounts);
                    const statusData = Object.values(statusCounts);
                    const statusColors = statusLabels.map(s => {
                        switch(s) {
                            case 'Researching': return '#C200FB';
                            case 'Contacted': return '#534EFF';
                            case 'Follow-up': return '#FFBC0A';
                            case 'Pledged': return '#EC0868';
                            case 'Closed': return '#FC2F00';
                            default: return '#cccccc';
                        }
                    });
                    
                    const sponsorStatusCtx = document.getElementById('sponsorStatusChart').getContext('2d');
                    sponsorStatusChart = new Chart(sponsorStatusCtx, {
                        type: 'pie',
                        data: {
                            labels: statusLabels,
                            datasets: [{
                                data: statusData,
                                backgroundColor: statusColors,
                                borderColor: '#ffffff',
                                borderWidth: 2,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(tooltipItem) {
                                            const label = tooltipItem.label || '';
                                            const value = tooltipItem.raw || 0;
                                            return `${label}: ${value} sponsors`;
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // Pledged Tiers Chart
                    if (pledgedTiersChart) pledgedTiersChart.destroy();
                    const tierLabels = Object.keys(pledgedTiers);
                    const tierData = Object.values(pledgedTiers);
                    const tierColors = tierLabels.map(t => {
                        switch(t) {
                            case 'Gold': return '#FFBC0A';
                            case 'Silver': return '#EC7D10';
                            case 'Bronze': return '#FC2F00';
                            case 'Custom': return '#EC0868';
                            default: return '#cccccc';
                        }
                    });
                    
                    const pledgedTiersCtx = document.getElementById('pledgedTiersChart').getContext('2d');
                    pledgedTiersChart = new Chart(pledgedTiersCtx, {
                        type: 'bar',
                        data: {
                            labels: tierLabels,
                            datasets: [{
                                label: 'Pledged Amount (₦)',
                                data: tierData,
                                backgroundColor: tierColors,
                                borderColor: tierColors,
                                borderWidth: 1,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(tooltipItem) {
                                            return `Pledged: ${formatCurrency(tooltipItem.raw)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                };

                const initDashboard = () => {
                    const sponsorsCollection = collection(db, `artifacts/${appId}/data/internal/sponsors`);
                    
                    // Real-time listener for sponsors data
                    window.firebase.onSnapshot(sponsorsCollection, (querySnapshot) => {
                        const sponsors = [];
                        let totalPledged = 0;
                        querySnapshot.forEach((doc) => {
                            const sponsor = { id: doc.id, ...doc.data() };
                            sponsors.push(sponsor);
                            if (sponsor.status === 'Pledged' && sponsor.pledgedAmount) {
                                totalPledged += parseInt(sponsor.pledgedAmount, 10);
                            }
                        });

                        // Filter and sort sponsors
                        const searchTerm = document.getElementById('search-input').value.toLowerCase();
                        const statusFilter = document.getElementById('status-filter').value;
                        
                        const filteredSponsors = sponsors.filter(sponsor => {
                            const matchesSearch = sponsor.companyName.toLowerCase().includes(searchTerm);
                            const matchesStatus = statusFilter === 'all' || sponsor.status === statusFilter;
                            return matchesSearch && matchesStatus;
                        });

                        // Sort by company name
                        filteredSponsors.sort((a, b) => a.companyName.localeCompare(b.companyName));

                        // Update dashboard widgets
                        document.getElementById('total-sponsors-count').textContent = sponsors.length;
                        document.getElementById('total-pledged-amount').textContent = formatCurrency(totalPledged);
                        const pledgedPercentage = ((totalPledged / sponsorshipGoal) * 100).toFixed(1);
                        document.getElementById('goal-progress').textContent = `${Math.min(100, pledgedPercentage)}%`;
                        
                        const contactedCount = sponsors.filter(s => s.status === 'Contacted' || s.status === 'Follow-up' || s.status === 'Pledged' || s.status === 'Closed').length;
                        document.getElementById('outreach-status-count').textContent = contactedCount;

                        // Render sponsor table
                        const sponsorsTableBody = document.getElementById('sponsors-table-body');
                        sponsorsTableBody.innerHTML = '';
                        if (filteredSponsors.length > 0) {
                            document.getElementById('no-sponsors-message').classList.add('hidden');
                            filteredSponsors.forEach(sponsor => {
                                sponsorsTableBody.appendChild(renderSponsorRow(sponsor, sponsor.id));
                            });
                        } else {
                            document.getElementById('no-sponsors-message').classList.remove('hidden');
                        }

                        // Update charts
                        updateCharts(sponsors);
                    }, (error) => {
                        console.error("Firestore Error:", error);
                        displayError("Firestore Connection Error", "Failed to fetch sponsors. Check your security rules and network connection.");
                    });

                    // Search and Filter event listeners
                    document.getElementById('search-input').addEventListener('input', () => {
                        // Re-fetch data to trigger the filter logic
                        window.firebase.onSnapshot(sponsorsCollection, () => {});
                    });
                    document.getElementById('status-filter').addEventListener('change', () => {
                        // Re-fetch data to trigger the filter logic
                        window.firebase.onSnapshot(sponsorsCollection, () => {});
                    });


                    // Handle Add/Edit Form submission
                    const sponsorForm = document.getElementById('sponsor-form');
                    sponsorForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const docId = document.getElementById('sponsor-id').value;
                        const data = {
                            companyName: document.getElementById('companyName').value,
                            contactPerson: document.getElementById('contactPerson').value,
                            email: document.getElementById('email').value,
                            tier: document.getElementById('tier').value,
                            pledgedAmount: parseInt(document.getElementById('pledgedAmount').value, 10) || 0,
                            status: document.getElementById('status').value,
                            notes: document.getElementById('notes').value
                        };
                        try {
                            if (docId) {
                                // Update existing sponsor
                                await window.firebase.updateDoc(window.firebase.doc(db, `artifacts/${appId}/data/internal/sponsors`, docId), data);
                            } else {
                                // Add new sponsor
                                await window.firebase.addDoc(sponsorsCollection, data);
                            }
                            document.getElementById('add-edit-modal').classList.add('hidden');
                            sponsorForm.reset();
                        } catch (e) {
                            console.error("Error adding/updating document: ", e);
                            displayError("Firestore Write Error", "Failed to save sponsor. Check your Firestore connection and security rules.");
                        }
                    });

                    // Handle open modal button
                    document.getElementById('add-sponsor-btn').addEventListener('click', () => {
                        const modal = document.getElementById('add-edit-modal');
                        const modalTitle = document.getElementById('modal-title');
                        const deleteBtn = document.getElementById('delete-btn');
                        modalTitle.textContent = 'Add Sponsor';
                        deleteBtn.classList.add('hidden');
                        document.getElementById('sponsor-form').reset();
                        document.getElementById('sponsor-id').value = '';
                        modal.classList.remove('hidden');
                    });

                    // Handle close modal button
                    document.getElementById('cancel-btn').addEventListener('click', () => {
                        document.getElementById('add-edit-modal').classList.add('hidden');
                    });
                    
                    // Handle clicking outside the modal to close
                    document.getElementById('add-edit-modal').addEventListener('click', (event) => {
                        if (event.target === document.getElementById('add-edit-modal')) {
                            document.getElementById('add-edit-modal').classList.add('hidden');
                        }
                    });


                    // Handle Edit/Email button clicks using event delegation
                    document.getElementById('sponsors-table-body').addEventListener('click', async (e) => {
                        const target = e.target.closest('button');
                        if (!target) return;

                        const docId = target.dataset.id;
                        
                        if (target.classList.contains('edit-btn')) {
                            const modal = document.getElementById('add-edit-modal');
                            const modalTitle = document.getElementById('modal-title');
                            const deleteBtn = document.getElementById('delete-btn');
                            modalTitle.textContent = 'Edit Sponsor';
                            deleteBtn.classList.remove('hidden');
                            document.getElementById('sponsor-id').value = docId;

                            try {
                                const docRef = window.firebase.doc(db, `artifacts/${appId}/data/internal/sponsors`, docId);
                                const docSnap = await window.firebase.getDoc(docRef);
                                if (docSnap.exists()) {
                                    const sponsor = docSnap.data();
                                    document.getElementById('companyName').value = sponsor.companyName;
                                    document.getElementById('contactPerson').value = sponsor.contactPerson;
                                    document.getElementById('email').value = sponsor.email;
                                    document.getElementById('tier').value = sponsor.tier;
                                    document.getElementById('pledgedAmount').value = sponsor.pledgedAmount;
                                    document.getElementById('status').value = sponsor.status;
                                    document.getElementById('notes').value = sponsor.notes;
                                    modal.classList.remove('hidden');
                                } else {
                                    displayError("Data Error", "No such sponsor found!");
                                }
                            } catch (e) {
                                console.error("Error fetching document: ", e);
                                displayError("Firestore Read Error", "Failed to fetch sponsor data. Check your Firestore connection.");
                            }
                        }
                    });

                    // Handle Delete button
                    document.getElementById('delete-btn').addEventListener('click', async () => {
                        const docId = document.getElementById('sponsor-id').value;
                        if (!docId) return;
                        
                        // Use a custom modal for confirmation
                        const confirmationModal = document.createElement('div');
                        confirmationModal.className = 'fixed z-50 inset-0 overflow-y-auto';
                        confirmationModal.innerHTML = `
                            <div class="flex items-center justify-center min-h-screen">
                                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
                                <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full p-6">
                                    <h3 class="text-lg font-medium text-gray-900">Confirm Deletion</h3>
                                    <p class="mt-2 text-sm text-gray-500">Are you sure you want to delete this sponsor?</p>
                                    <div class="mt-4 flex justify-end space-x-3">
                                        <button id="confirm-delete-cancel" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                                        <button id="confirm-delete-proceed" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(confirmationModal);
                        
                        document.getElementById('confirm-delete-cancel').addEventListener('click', () => {
                            confirmationModal.remove();
                        });
                        
                        document.getElementById('confirm-delete-proceed').addEventListener('click', async () => {
                            try {
                                await window.firebase.deleteDoc(window.firebase.doc(db, `artifacts/${appId}/data/internal/sponsors`, docId));
                                document.getElementById('add-edit-modal').classList.add('hidden');
                                confirmationModal.remove();
                            } catch (e) {
                                console.error("Error deleting document: ", e);
                                displayError("Firestore Delete Error", "Failed to delete sponsor. Check your Firestore connection and security rules.");
                                confirmationModal.remove();
                            }
                        });
                    });

                };
                
            } catch (e) {
                console.error("Failed to initialize the app. Check your Firebase config and Netlify environment variables.", e);
                const displayError = (title, message) => {
                    const errorModal = document.getElementById('error-modal');
                    document.getElementById('error-title').textContent = title;
                    document.getElementById('error-message').textContent = message;
                    errorModal.classList.remove('hidden');
                };
                displayError("Initialization Error", "The app failed to initialize. Ensure your firebaseConfig object is correct and your internet connection is stable.");
            }
        };

    </script>
</body>
</html>
